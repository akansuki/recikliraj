<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recikliraj!</title>
    <meta
      name="description"
      content="Mapa reciklažnih mesta za papir, baterije i aluminijum"
    />
    <style>
      .info-panel {
        background-color: white;
        border: 2px solid grey;
        padding: 10px;
        border-radius: 5px;
        z-index: 9999;
        transition: all 0.3s ease;
      }

      .stats .panel-content {
        padding: 5px;
      }

      .stats .panel-content p {
        margin: 5px 0;
        line-height: 1.4;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }

      .panel-content {
        display: block;
        transition: all 0.3s ease;
      }

      .panel-content.hidden {
        display: none;
      }

      .toggle-button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
      }

      .logo {
        position: fixed;
        bottom: 50px;
        left: 50px;
        z-index: 9999;
        pointer-events: none;
      }

      .logo img {
        max-width: 100px;
        height: auto;
        display: block;
      }

      @media screen and (min-width: 769px) {
        .methodology {
          position: fixed;
          left: 50px;
          top: 50px;
          width: 300px;
          font-size: 14px;
        }

        .stats {
          position: fixed;
          top: 50px;
          right: 50px;
          width: 140px;
          font-size: 12px;
        }

        .legend {
          position: fixed;
          bottom: 50px;
          right: 50px;
          width: 160px;
          font-size: 14px;
        }
      }

      @media screen and (max-width: 768px) {
        .info-panel {
          position: fixed;
          left: 0;
          right: 0;
          margin: 10px;
          max-height: 60vh;
          overflow-y: auto;
          transform: translateX(120%);
        }

        .methodology {
          top: 10px;
        }

        .stats {
          top: 10px;
        }

        .legend {
          bottom: 10px;
        }

        .logo {
          bottom: 10px;
          left: 10px;
        }

        .logo img {
          max-width: 80px;
        }

        .info-panel.active {
          transform: translateX(0);
        }

        .panel-content {
          font-size: 12px;
        }
      }

      .mobile-menu {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
      }

      @media screen and (max-width: 768px) {
        .mobile-menu {
          display: flex;
          gap: 10px;
        }

        .menu-button {
          background: white;
          border: 2px solid grey;
          padding: 10px;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
      }
    </style>

    <script>
      L_NO_TOUCH = false;
      L_DISABLE_3D = false;
    </script>

    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <style>
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"
    />

    <meta
      name="viewport"
      content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <style>
      #map_51cbb90e3763f2ebacfb9351343e5534 {
        position: relative;
        width: 100%;
        height: 100%;
        left: 0%;
        top: 0%;
      }
      .leaflet-container {
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="methodology info-panel">
      <div class="panel-header" onclick="toggleContent(this)">
        <h4 style="margin: 0">O projektu</h4>
        <button class="toggle-button">−</button>
      </div>
      <div class="panel-content">
        <p style="font-size: 12px">
          Ova mapa prikazuje reciklažna mesta za papir, baterije i
          aluminijum.<br /><br />
          <i>Podaci ažurirani: Novembra 2025</i>
        </p>
      </div>
    </div>

    <div class="stats info-panel">
      <div class="panel-header" onclick="toggleContent(this)">
        <h4 style="margin: 0">Statistika</h4>
        <button class="toggle-button">−</button>
      </div>
      <div class="panel-content">
        <p>
          Papir: ?<br />
          Baterije: ?<br />
          Aluminijum: ?
        </p>
      </div>
    </div>

    <div class="legend info-panel">
      <div class="panel-header" onclick="toggleContent(this)">
        <h4 style="margin: 0">Legenda:</h4>
        <button class="toggle-button">−</button>
      </div>
      <div class="panel-content">
        <div style="margin-left: 5px">
          <p style="margin: 0 0 8px 0">
            <i class="fa fa-newspaper" style="color: orange"></i> Papir
          </p>
          <p style="margin: 0 0 8px 0">
            <i class="fa fa-battery-full" style="color: blue"></i> Baterije
          </p>
          <p style="margin: 0 0 8px 0">
            <i class="fa fa-recycle" style="color: purple"></i> Aluminijum
          </p>
          <p style="margin: 0 0 8px 0">
            <i class="fa fa-recycle" style="color: green"></i> Kombinovano
          </p>
        </div>
      </div>
    </div>

    <div class="mobile-menu">
      <button class="menu-button" onclick="togglePanel('methodology')">
        <i class="fa fa-info"></i>
      </button>
      <button class="menu-button" onclick="togglePanel('stats')">
        <i class="fa fa-chart-bar"></i>
      </button>
      <button class="menu-button" onclick="togglePanel('legend')">
        <i class="fa fa-list"></i>
      </button>
    </div>

    <div class="logo">
      <img src="kplogo.png" alt="KP Logo" />
    </div>

    <script>
      function togglePanel(panelId) {
        const panels = document.querySelectorAll(".info-panel");
        panels.forEach((panel) => {
          if (panel.classList.contains(panelId)) {
            panel.classList.toggle("active");
          } else {
            panel.classList.remove("active");
          }
        });
      }

      function toggleContent(element) {
        const content = element.nextElementSibling;
        const button = element.querySelector(".toggle-button");
        if (content.classList.contains("hidden")) {
          content.classList.remove("hidden");
          button.innerHTML = "−";
        } else {
          content.classList.add("hidden");
          button.innerHTML = "+";
        }
      }
    </script>

    <div class="folium-map" id="map_51cbb90e3763f2ebacfb9351343e5534"></div>
  </body>
  <script>
    var map_51cbb90e3763f2ebacfb9351343e5534 = L.map(
      "map_51cbb90e3763f2ebacfb9351343e5534",
      {
        center: [45.2671, 19.8335],
        crs: L.CRS.EPSG3857,
        zoom: 12.5,
        zoomControl: true,
        preferCanvas: false,
      }
    );

    var tile_layer_513e03d3631fb515d481a3220a9fa72f = L.tileLayer(
      "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        minZoom: 0,
        maxZoom: 19,
        maxNativeZoom: 19,
        noWrap: false,
        attribution:
          '\u0026copy; \u003ca href="https://www.openstreetmap.org/copyright"\u003eOpenStreetMap\u003c/a\u003e contributors',
        subdomains: "abc",
        detectRetina: false,
        tms: false,
        opacity: 1,
      }
    );

    tile_layer_513e03d3631fb515d481a3220a9fa72f.addTo(
      map_51cbb90e3763f2ebacfb9351343e5534
    );

    // Geolocation support - get user's location
    var userLocationMarker = null;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          var userLat = position.coords.latitude;
          var userLng = position.coords.longitude;

          // Center map on user's location with appropriate zoom
          map_51cbb90e3763f2ebacfb9351343e5534.setView([userLat, userLng], 14);

          // Add marker for user's location
          var userIcon = L.AwesomeMarkers.icon({
            markerColor: "red",
            iconColor: "white",
            icon: "user",
            prefix: "fa",
            extraClasses: "fa-rotate-0",
          });

          userLocationMarker = L.marker([userLat, userLng], { icon: userIcon })
            .addTo(map_51cbb90e3763f2ebacfb9351343e5534)
            .bindPopup("Vaša lokacija");
        },
        function (error) {
          // User denied permission or geolocation unavailable
          // Keep default center (Novi Sad)
          console.log("Geolocation not available: ", error.message);
        }
      );
    }

    // Load markers from JSON and create them dynamically
    var markersData = [];
    var markerCounts = {
      battery: 0,
      aluminum: 0,
      paper: 0,
    };

    // Function to validate marker data
    function validateMarker(markerData, index) {
      var errors = [];

      // Check if markerData exists
      if (!markerData) {
        errors.push("Marker data is missing");
        return { valid: false, errors: errors };
      }

      // Check for types (array) or type (single) - support both formats
      var types = [];
      if (markerData.types) {
        // New format: types array
        if (!Array.isArray(markerData.types)) {
          errors.push("'types' must be an array");
        } else if (markerData.types.length === 0) {
          errors.push("'types' array cannot be empty");
        } else {
          markerData.types.forEach(function (type, i) {
            if (!["paper", "battery", "aluminum"].includes(type)) {
              errors.push(
                "Invalid type at index " +
                  i +
                  ": '" +
                  type +
                  "'. Must be 'paper', 'battery', or 'aluminum'"
              );
            } else {
              types.push(type);
            }
          });
        }
      } else if (markerData.type) {
        // Old format: single type (for backward compatibility)
        if (!["paper", "battery", "aluminum"].includes(markerData.type)) {
          errors.push(
            "Invalid 'type': '" +
              markerData.type +
              "'. Must be 'paper', 'battery', or 'aluminum'"
          );
        } else {
          types.push(markerData.type);
        }
      } else {
        errors.push("Missing 'type' or 'types' field");
      }

      if (!markerData.coordinates) {
        errors.push("Missing 'coordinates' field");
      } else if (!Array.isArray(markerData.coordinates)) {
        errors.push("'coordinates' must be an array [latitude, longitude]");
      } else if (markerData.coordinates.length !== 2) {
        errors.push(
          "'coordinates' must have exactly 2 values [latitude, longitude]"
        );
      } else {
        var lat = markerData.coordinates[0];
        var lng = markerData.coordinates[1];

        if (typeof lat !== "number" || typeof lng !== "number") {
          errors.push("Coordinates must be numbers");
        } else {
          if (lat < -90 || lat > 90) {
            errors.push("Latitude must be between -90 and 90, got: " + lat);
          }
          if (lng < -180 || lng > 180) {
            errors.push("Longitude must be between -180 and 180, got: " + lng);
          }
        }
      }

      if (!markerData.name) {
        errors.push("Missing 'name' field");
      } else if (
        typeof markerData.name !== "string" ||
        markerData.name.trim() === ""
      ) {
        errors.push("'name' must be a non-empty string");
      }

      return {
        valid: errors.length === 0,
        errors: errors,
        types: types, // Return validated types array
      };
    }

    // Function to log validation errors to console
    var validationErrors = [];
    function logValidationErrors() {
      if (validationErrors.length === 0) {
        return;
      }

      // Log to console only
      console.error("Data validation errors:", validationErrors);
    }

    // Function to get icon and color based on marker type
    function getMarkerStyle(type) {
      var styles = {
        paper: { icon: "newspaper", color: "orange" },
        battery: { icon: "battery-full", color: "blue" },
        aluminum: { icon: "recycle", color: "purple" },
      };
      return styles[type] || { icon: "circle", color: "gray" };
    }

    // Function to calculate offset coordinates for multiple markers at same location
    function getOffsetCoordinates(baseCoords, index, total) {
      // Small offset to spread markers (approximately 50 meters)
      var offsetDistance = 0.0005; // degrees (roughly 50m)
      var angle = (2 * Math.PI * index) / total; // Distribute in circle
      return [
        baseCoords[0] + offsetDistance * Math.cos(angle),
        baseCoords[1] + offsetDistance * Math.sin(angle),
      ];
    }

    // Function to create marker(s) from data - supports multiple types
    function createMarker(markerData, types) {
      var markers = [];

      // Get types array (support both old 'type' and new 'types' format)
      var markerTypes = types || markerData.types || [markerData.type];

      // If multiple types, create single universal green recycling icon
      if (markerTypes.length > 1) {
        var marker = L.marker(markerData.coordinates, {}).addTo(
          map_51cbb90e3763f2ebacfb9351343e5534
        );

        // Universal green recycling icon for multiple types
        var icon = L.AwesomeMarkers.icon({
          markerColor: "green",
          iconColor: "white",
          icon: "recycle",
          prefix: "fa",
          extraClasses: "fa-rotate-0",
        });
        marker.setIcon(icon);

        // Show all types in popup
        var typeLabels = {
          paper: "Papir",
          battery: "Baterije",
          aluminum: "Aluminijum",
        };
        var typeList = markerTypes
          .map(function (t) {
            return typeLabels[t];
          })
          .join(", ");
        var popupText =
          markerData.name + "<br><small>Tipovi: " + typeList + "</small>";

        var popup = L.popup({ maxWidth: "100%" });
        var htmlContent = $(
          '<div style="width: 100.0%; height: 100.0%;">' + popupText + "</div>"
        )[0];
        popup.setContent(htmlContent);
        marker.bindPopup(popup);

        marker.bindTooltip("<div>" + markerData.name + "</div>", {
          sticky: true,
        });

        markers.push(marker);
      } else {
        // Single type - create marker with specific icon
        var type = markerTypes[0];
        var marker = L.marker(markerData.coordinates, {}).addTo(
          map_51cbb90e3763f2ebacfb9351343e5534
        );

        var style = getMarkerStyle(type);
        var icon = L.AwesomeMarkers.icon({
          markerColor: style.color,
          iconColor: "white",
          icon: style.icon,
          prefix: "fa",
          extraClasses: "fa-rotate-0",
        });
        marker.setIcon(icon);

        var popup = L.popup({ maxWidth: "100%" });
        var htmlContent = $(
          '<div style="width: 100.0%; height: 100.0%;">' +
            markerData.name +
            "</div>"
        )[0];
        popup.setContent(htmlContent);
        marker.bindPopup(popup);

        marker.bindTooltip("<div>" + markerData.name + "</div>", {
          sticky: true,
        });

        markers.push(marker);
      }

      return markers;
    }

    // Function to update statistics panel
    function updateStatistics() {
      var totalPaperRecycle = markerCounts.paper;
      var totalBatteryRecycle = markerCounts.battery;
      var totalAluminumRecycle = markerCounts.aluminum;

      var statsContent = document.querySelector(".stats .panel-content p");
      if (statsContent) {
        statsContent.innerHTML =
          "Papir: " +
          totalPaperRecycle +
          "<br />" +
          "Baterije: " +
          totalBatteryRecycle +
          "<br />" +
          "Aluminijum: " +
          totalAluminumRecycle;
      }
    }

    // Load markers from JSON file
    fetch("markers.json")
      .then((response) => response.json())
      .then((data) => {
        // Validate that data is an array
        if (!Array.isArray(data)) {
          console.error("Error: markers.json must contain an array");
          validationErrors.push("markers.json mora biti niz objekata");
          logValidationErrors();
          return;
        }

        markersData = data;
        validationErrors = []; // Reset errors

        // Validate and create markers
        data.forEach(function (markerData, index) {
          var validation = validateMarker(markerData, index);

          if (validation.valid) {
            // Create markers (one per type) - supports multiple types per location
            createMarker(markerData, validation.types);

            // Count each type (a location with multiple types counts in all categories)
            validation.types.forEach(function (type) {
              if (type === "battery") {
                markerCounts.battery++;
              } else if (type === "aluminum") {
                markerCounts.aluminum++;
              } else if (type === "paper") {
                markerCounts.paper++;
              }
            });
          } else {
            // Log validation errors
            console.error(
              "Invalid marker at index " + index + ":",
              validation.errors
            );
            validation.errors.forEach(function (error) {
              validationErrors.push("Marker " + (index + 1) + ": " + error);
            });
          }
        });

        // Update statistics panel
        updateStatistics();

        // Log validation errors if any (console only)
        logValidationErrors();

        // Log validation summary
        var totalMarkers =
          markerCounts.battery + markerCounts.aluminum + markerCounts.paper;
        var skippedMarkers = data.length - totalMarkers;
        console.log("Marker validation summary:", {
          total: totalMarkers,
          battery: markerCounts.battery,
          aluminum: markerCounts.aluminum,
          paper: markerCounts.paper,
          skipped: skippedMarkers,
          errors: validationErrors.length,
        });
      })
      .catch((error) => {
        console.error("Error loading markers.json:", error);
      });
  </script>
</html>
